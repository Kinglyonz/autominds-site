<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMinds | AI Email Agent</title>
    <meta name="description" content="Talk to your AI email assistant. Connect Gmail and get instant inbox insights.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="logo_white.svg">
    <style>
        :root {
            --bg:#0a0a0a;--bg2:#111111;--bg3:#161616;
            --text:#f5f5f5;--text2:rgba(255,255,255,.65);--text3:rgba(255,255,255,.35);
            --accent:#3B82F6;--green:#22c55e;--purple:#A855F7;--red:#ef4444;
            --border:rgba(255,255,255,.08);--border2:rgba(255,255,255,.15);
            --font:'Inter',-apple-system,sans-serif;--heading:'Space Grotesk',sans-serif;--mono:'JetBrains Mono',monospace;
            --rs:8px;
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        html{-webkit-font-smoothing:antialiased}
        body{font-family:var(--font);background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

        /* â”€â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);background:rgba(10,10,10,.9);backdrop-filter:blur(16px);flex-shrink:0;z-index:50}
        .nav-left{display:flex;align-items:center;gap:10px}
        .nav-logo{width:28px;height:28px}
        .nav-brand{font-family:var(--heading);font-size:16px;font-weight:700;color:var(--text);text-decoration:none}
        .nav-badge{font-size:10px;padding:2px 8px;border-radius:20px;background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff;font-weight:600}
        .nav-right{display:flex;align-items:center;gap:8px}
        .nav-link{font-size:12px;color:var(--text3);text-decoration:none;padding:5px 10px;border:1px solid var(--border);border-radius:var(--rs);transition:all .2s}
        .nav-link:hover{border-color:var(--border2);color:var(--text2)}
        .nav-status{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);padding:4px 10px;border-radius:20px;border:1px solid var(--border)}
        .nav-status .dot{width:6px;height:6px;border-radius:50%;animation:pulse 2s ease-in-out infinite}
        .dot-on{background:var(--green)}
        .dot-off{background:var(--red)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

        /* Gmail pill */
        .gmail-pill{display:flex;align-items:center;gap:6px;font-size:12px;padding:5px 12px;border-radius:20px;border:none;cursor:pointer;font-family:var(--font);font-weight:500;transition:all .2s;text-decoration:none}
        .gmail-pill.connect{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.25)}
        .gmail-pill.connect:hover{background:rgba(168,85,247,.2)}
        .gmail-pill.connected{background:rgba(34,197,94,.08);color:var(--green);border:1px solid rgba(34,197,94,.15)}
        .gmail-pill .pill-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
        .gmail-wrap{position:relative}
        .disconnect-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--rs);padding:4px;z-index:100;min-width:140px}
        .disconnect-dropdown.show{display:block}
        .disconnect-option{display:block;width:100%;padding:8px 12px;border:none;background:none;color:var(--red);font-family:var(--font);font-size:12px;cursor:pointer;text-align:left;border-radius:4px}
        .disconnect-option:hover{background:rgba(239,68,68,.1)}

        /* â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat{flex:1;display:flex;flex-direction:column;overflow:hidden;max-width:800px;margin:0 auto;width:100%}
        .messages{flex:1;overflow-y:auto;padding:24px 20px;display:flex;flex-direction:column;gap:16px}
        .messages::-webkit-scrollbar{width:5px}
        .messages::-webkit-scrollbar-track{background:transparent}
        .messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

        /* Welcome */
        .welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
        .welcome-icon{font-size:48px;margin-bottom:16px}
        .welcome h2{font-family:var(--heading);font-size:22px;font-weight:700;margin-bottom:6px}
        .welcome p{color:var(--text2);font-size:14px;max-width:400px;line-height:1.6;margin-bottom:8px}
        .welcome .scope-note{color:var(--text3);font-size:12px;margin-bottom:28px}
        .suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:520px}
        .suggestion{padding:10px 16px;border:1px solid var(--border);border-radius:20px;background:transparent;cursor:pointer;font-size:13px;color:var(--text2);font-family:var(--font);transition:all .2s;white-space:nowrap}
        .suggestion:hover{border-color:var(--purple);color:var(--text);background:rgba(168,85,247,.06)}

        /* Messages */
        .msg{display:flex;gap:12px;max-width:680px;width:100%}
        .msg.user{align-self:flex-end;flex-direction:row-reverse}
        .msg-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:2px}
        .msg.assistant .msg-avatar{background:linear-gradient(135deg,var(--purple),var(--accent))}
        .msg.user .msg-avatar{background:rgba(255,255,255,.1)}
        .msg-body{padding:14px 18px;border-radius:16px;font-size:14px;line-height:1.7;max-width:580px}
        .msg.assistant .msg-body{background:var(--bg3);border:1px solid var(--border);border-top-left-radius:4px}
        .msg.user .msg-body{background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.2);border-top-right-radius:4px;color:var(--text)}
        .msg-body p{margin-bottom:8px}.msg-body p:last-child{margin-bottom:0}
        .msg-body ul,.msg-body ol{margin:8px 0;padding-left:20px}
        .msg-body li{margin-bottom:4px}
        .msg-body strong{color:var(--text);font-weight:600}
        .msg-body code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:12px}
        .msg-time{font-size:10px;color:var(--text3);margin-top:4px}
        .typing{display:flex;gap:4px;padding:12px 18px;align-items:center}
        .typing-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);animation:bounce .6s ease-in-out infinite}
        .typing-dot:nth-child(2){animation-delay:.15s}
        .typing-dot:nth-child(3){animation-delay:.3s}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

        /* Input */
        .input-bar{padding:16px 20px;border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0}
        .input-row{display:flex;align-items:flex-end;gap:10px;max-width:680px;margin:0 auto}
        .input-wrap{flex:1;position:relative}
        .input-field{width:100%;padding:14px 18px;padding-right:44px;border:1px solid var(--border);border-radius:16px;background:var(--bg3);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.5;resize:none;outline:none;transition:border-color .2s;max-height:120px;overflow-y:auto}
        .input-field:focus{border-color:var(--purple)}
        .input-field::placeholder{color:var(--text3)}
        .mic-btn{position:absolute;right:8px;bottom:8px;width:32px;height:32px;border-radius:50%;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
        .mic-btn:hover{background:rgba(255,255,255,.05);color:var(--text2)}
        .mic-btn.recording{background:rgba(239,68,68,.2);color:var(--red);animation:pulse 1s ease-in-out infinite}
        .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
        .send-btn:hover{opacity:.9;transform:scale(1.05)}
        .send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
        .input-hint{text-align:center;font-size:11px;color:var(--text3);margin-top:8px}

        @media(max-width:640px){
            .suggestions{flex-direction:column;align-items:center}
            .nav-link{display:none}
        }
    </style>
</head>
<body>
    <div class="nav">
        <div class="nav-left">
            <img src="logo_white.svg" alt="AutoMinds" class="nav-logo">
            <a href="index.html" class="nav-brand">AutoMinds</a>
            <span class="nav-badge">Email Agent</span>
        </div>
        <div class="nav-right">
            <span class="nav-status" id="statusPill">
                <span class="dot dot-off" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </span>
            <div class="gmail-wrap">
                <a class="gmail-pill connect" id="gmailConnectBtn" href="/api/email-proxy?action=gmail-auth">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    Connect Gmail
                </a>
                <button class="gmail-pill connected" id="gmailConnectedBtn" style="display:none" onclick="toggleDisconnect()">
                    <span class="pill-dot"></span>
                    <span id="userLabel">Gmail Connected</span>
                </button>
                <div class="disconnect-dropdown" id="disconnectDropdown">
                    <div id="userInfo" style="padding:8px 12px;font-size:11px;color:var(--text3);border-bottom:1px solid var(--border)"></div>
                    <button class="disconnect-option" onclick="disconnectGmail()">Disconnect & Logout</button>
                </div>
            </div>
            <a href="index.html" class="nav-link">&larr; Home</a>
        </div>
    </div>

    <div class="chat">
        <div class="messages" id="messagesArea">
            <div class="welcome" id="welcomeScreen">
                <div class="welcome-icon">ğŸ“¬</div>
                <h2>Your AI email assistant</h2>
                <p>Connect your Gmail and ask me anything. I'll read your actual emails and give you a real answer.</p>
                <div class="scope-note">By default I look at the last 3 days. Say "today" or "this week" for different ranges.</div>
                <div class="suggestions">
                    <button class="suggestion" onclick="quickAction('What\'s important today?')">What's important today?</button>
                    <button class="suggestion" onclick="quickAction('Summarize my week')">Summarize my week</button>
                    <button class="suggestion" onclick="quickAction('Anything I need to reply to?')">Need to reply?</button>
                    <button class="suggestion" onclick="quickAction('Find emails from my boss')">Search emails</button>
                    <button class="suggestion" onclick="quickAction('Show my reminders')">My reminders</button>
                    <button class="suggestion" onclick="quickAction('Remind me to check invoices tomorrow')">Set a reminder</button>
                </div>
            </div>
        </div>

        <div class="input-bar">
            <div class="input-row">
                <div class="input-wrap">
                    <textarea class="input-field" id="chatInput" placeholder="Ask about your inbox..." rows="1" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
                    <button class="mic-btn" id="micBtn" onclick="toggleVoice()" title="Voice input">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </button>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send message">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
            <div class="input-hint">Press Enter to send Â· Shift+Enter for new line Â· Click ğŸ¤ to talk</div>
        </div>
    </div>

<script>
var API = '/api/email-proxy';
var chatHistory = [];
var isProcessing = false;
var sessionToken = null;
var userEmail = null;
var userName = null;

// â”€â”€â”€ Health Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function checkHealth() {
    fetch(API + '?action=health').then(function(r){return r.json()}).then(function(d){
        var dot = document.getElementById('statusDot');
        var txt = document.getElementById('statusText');
        if (d.status === 'ok') {
            dot.className = 'dot dot-on';
            txt.textContent = d.model ? d.model + ' Online' : 'AI Online';
        } else {
            dot.className = 'dot dot-off'; txt.textContent = 'Starting...';
        }
    }).catch(function(){
        document.getElementById('statusDot').className = 'dot dot-off';
        document.getElementById('statusText').textContent = 'Offline';
    });
})();

// â”€â”€â”€ Auth / Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGmail() {
    // Check URL hash for OAuth callback (session token + user info)
    if (window.location.hash.indexOf('gmail_tokens=') !== -1) {
        try {
            var match = window.location.hash.match(/gmail_tokens=([^&]+)/);
            if (match) {
                var data = JSON.parse(decodeURIComponent(match[1]));
                // Store session token (new system)
                if (data.session_token) {
                    localStorage.setItem('autominds_session', data.session_token);
                    localStorage.setItem('autominds_email', data.email || '');
                    localStorage.setItem('autominds_name', data.name || '');
                }
                // Also store raw tokens for backward compatibility
                if (data.access_token) {
                    localStorage.setItem('autominds_gmail', JSON.stringify({
                        access_token: data.access_token,
                        refresh_token: data.refresh_token,
                        expiry_date: data.expiry_date,
                    }));
                }
                history.replaceState(null, '', window.location.pathname);
                addMessage('assistant', "Welcome" + (data.name ? ", " + data.name : "") + "! Gmail connected. Try asking \"What's important today?\" or \"Summarize my week.\"");
            }
        } catch (e) { console.error('Token parse error:', e); }
    }

    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('error')) {
        addMessage('assistant', "Couldn't connect Gmail. Please try again. (" + urlParams.get('error') + ")");
        history.replaceState(null, '', window.location.pathname);
    }

    // Restore session
    sessionToken = localStorage.getItem('autominds_session');
    userEmail = localStorage.getItem('autominds_email');
    userName = localStorage.getItem('autominds_name');

    // Validate session if we have one
    if (sessionToken) {
        fetchWithAuth(API + '?action=user/me').then(function(r){return r.json()}).then(function(d){
            if (d.success && d.data) {
                userEmail = d.data.email;
                userName = d.data.name;
                localStorage.setItem('autominds_email', userEmail || '');
                localStorage.setItem('autominds_name', userName || '');
            } else {
                // Session expired â€” clear
                clearSession();
            }
            updateGmailUI();
        }).catch(function(){ updateGmailUI(); });
    }

    updateGmailUI();
}

function getAuthHeaders() {
    var headers = { 'Content-Type': 'application/json' };
    if (sessionToken) {
        headers['Authorization'] = 'Bearer ' + sessionToken;
    }
    return headers;
}

function fetchWithAuth(url, opts) {
    opts = opts || {};
    opts.headers = Object.assign(getAuthHeaders(), opts.headers || {});
    return fetch(url, opts);
}

function updateGmailUI() {
    var hasSession = !!sessionToken;
    var hasTokens = !!localStorage.getItem('autominds_gmail');
    var connected = hasSession || hasTokens;

    document.getElementById('gmailConnectBtn').style.display = connected ? 'none' : 'flex';
    document.getElementById('gmailConnectedBtn').style.display = connected ? 'flex' : 'none';

    var label = document.getElementById('userLabel');
    var info = document.getElementById('userInfo');
    if (connected && userEmail) {
        label.textContent = userName || userEmail.split('@')[0];
        info.textContent = userEmail;
        info.style.display = 'block';
    } else if (connected) {
        label.textContent = 'Gmail Connected';
        info.style.display = 'none';
    }
}

function toggleDisconnect() {
    var dd = document.getElementById('disconnectDropdown');
    dd.classList.toggle('show');
    if (dd.classList.contains('show')) {
        setTimeout(function() { document.addEventListener('click', function cl() { dd.classList.remove('show'); document.removeEventListener('click', cl); }, { once: true }); }, 10);
    }
}

function clearSession() {
    sessionToken = null; userEmail = null; userName = null;
    localStorage.removeItem('autominds_session');
    localStorage.removeItem('autominds_email');
    localStorage.removeItem('autominds_name');
    localStorage.removeItem('autominds_gmail');
}

function disconnectGmail() {
    // Tell server to destroy session
    if (sessionToken) {
        fetchWithAuth(API + '?action=user/logout', { method: 'POST' }).catch(function(){});
    }
    clearSession();
    updateGmailUI();
    addMessage('assistant', "Logged out. Connect Gmail again anytime.");
}

function getTokens() {
    var raw = localStorage.getItem('autominds_gmail');
    return raw ? JSON.parse(raw) : null;
}

// â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage(text) {
    var input = document.getElementById('chatInput');
    var msg = text || input.value.trim();
    if (!msg || isProcessing) return;
    var welcome = document.getElementById('welcomeScreen');
    if (welcome) welcome.remove();
    addMessage('user', msg);
    input.value = '';
    input.style.height = 'auto';
    chatHistory.push({ role: 'user', content: msg });
    var typingId = showTyping();
    isProcessing = true;
    document.getElementById('sendBtn').disabled = true;

    var tokens = getTokens();
    var hasAuth = sessionToken || tokens;
    var endpoint = hasAuth ? 'email/chat' : 'demo/chat';
    var body = { message: msg, history: chatHistory.slice(-10) };

    // Prefer session auth, fall back to raw tokens
    if (!sessionToken && tokens) body.tokens = tokens;

    fetchWithAuth(API + '?action=' + endpoint, {
        method: 'POST',
        body: JSON.stringify(body),
    }).then(function(r) { return r.json(); }).then(function(d) {
        removeTyping(typingId);
        if (d.error && d.error.indexOf('Rate limit') !== -1) {
            addMessage('assistant', "âš ï¸ " + d.error + " You've been making a lot of requests. Take a short break and try again.");
        } else if (d.success && d.data && d.data.reply) {
            addMessage('assistant', d.data.reply);
            chatHistory.push({ role: 'assistant', content: d.data.reply });
        } else {
            addMessage('assistant', 'Something went wrong. ' + (d.error || 'Try again.'));
        }
    }).catch(function() {
        removeTyping(typingId);
        addMessage('assistant', "Connection issue â€” try again in a moment.");
    }).finally(function() {
        isProcessing = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
    });
}

function quickAction(text) { document.getElementById('chatInput').value = text; sendMessage(text); }

function addMessage(role, content) {
    var area = document.getElementById('messagesArea');
    var div = document.createElement('div');
    div.className = 'msg ' + role;
    var avatar = role === 'assistant' ? 'ğŸ¤–' : 'ğŸ‘¤';
    div.innerHTML =
        '<div class="msg-avatar">' + avatar + '</div>' +
        '<div><div class="msg-body">' + formatMessage(content) + '</div>' +
        '<div class="msg-time">' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function formatMessage(text) {
    var d = document.createElement('div'); d.textContent = text; var e = d.innerHTML;
    return e
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^[\s]*[-â€¢]\s+(.+)/gm, '<li>$1</li>')
        .replace(/^[\s]*(\d+)\.\s+(.+)/gm, '<li>$2</li>')
        .replace(/((?:<li>.*?<\/li>\s*)+)/g, '<ul>$1</ul>')
        .replace(/\n/g, '<br>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
}

var typingCounter = 0;
function showTyping() {
    var id = 'typing-' + (++typingCounter);
    var area = document.getElementById('messagesArea');
    var div = document.createElement('div');
    div.className = 'msg assistant'; div.id = id;
    div.innerHTML = '<div class="msg-avatar">ğŸ¤–</div><div class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
    area.appendChild(div); area.scrollTop = area.scrollHeight;
    return id;
}
function removeTyping(id) { var el = document.getElementById(id); if (el) el.remove(); }

// â”€â”€â”€ Voice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var recognition = null, isRecording = false;
function initVoice() {
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { document.getElementById('micBtn').style.display = 'none'; return; }
    recognition = new SR(); recognition.continuous = false; recognition.interimResults = true; recognition.lang = 'en-US';
    recognition.onresult = function(ev) {
        var t = ''; for (var i = ev.resultIndex; i < ev.results.length; i++) t += ev.results[i][0].transcript;
        document.getElementById('chatInput').value = t;
        if (ev.results[ev.results.length - 1].isFinal) { stopVoice(); if (t.trim()) setTimeout(function() { sendMessage(); }, 300); }
    };
    recognition.onerror = function() { stopVoice(); };
    recognition.onend = function() { stopVoice(); };
}
function toggleVoice() { isRecording ? stopVoice() : startVoice(); }
function startVoice() { if (!recognition) return; isRecording = true; document.getElementById('micBtn').classList.add('recording'); document.getElementById('chatInput').placeholder = 'Listening...'; recognition.start(); }
function stopVoice() { isRecording = false; document.getElementById('micBtn').classList.remove('recording'); document.getElementById('chatInput').placeholder = 'Ask about your inbox...'; if (recognition) try { recognition.stop(); } catch(e) {} }

function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function autoGrow(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }

initGmail(); initVoice(); document.getElementById('chatInput').focus();
</script>
</body>
</html>
